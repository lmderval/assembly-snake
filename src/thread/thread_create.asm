GLOBAL thread_create

EXTERN stack_create

CLONE_VM	    EQU 0x00000100
CLONE_FS	    EQU 0x00000200
CLONE_FILES	    EQU 0x00000400
CLONE_SIGHAND	EQU 0x00000800
CLONE_PARENT	EQU 0x00008000
CLONE_THREAD	EQU 0x00010000
CLONE_IO	    EQU 0x80000000

THREAD_FLAGS    EQU CLONE_VM | CLONE_FS | CLONE_FILES | CLONE_SIGHAND | CLONE_PARENT | CLONE_THREAD | CLONE_IO

SECTION .text
thread_create:
	PUSH rdi
	MOV rdi, rsi
	CALL stack_create
	LEA rsi, [rax + rsi - 8]
	POP QWORD [rsi]
	MOV rdi, THREAD_FLAGS
	MOV rax, 0x38
	SYSCALL
	RET
